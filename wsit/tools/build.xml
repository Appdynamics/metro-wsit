<?xml version="1.0" encoding="UTF-8"?>
<!-- You may freely edit this file. See commented blocks below for -->
<!-- some examples of how to customize the build. -->
<!-- (If you delete it and reopen the project it will be recreated.) -->
<project name="WSIT-Tools" default="default" basedir=".">
    <description>Builds, tests, and runs the project WSIT-Tools.</description>
    <import file="nbproject/build-impl.xml"/>
    <import file="../properties.xml"/>

    <taskdef name="concatmanifest" classname="taskdefs.ConcatManifest">
        <classpath>
            <fileset dir="../${etc.lib.dir}" includes="wsit-taskdefs.jar"/>
        </classpath>
    </taskdef>

    <macrodef name="expand-jars-macro">
        <attribute name="libdir"/>
        <element name="metainf" optional="true"/>
        <sequential>
            <property name="tmpdir" value="${dist.image.dir}/tmp"/>
            <copy file="../${etc.metainf.dir}/MANIFEST.MF" todir="${tmpdir}"/>
            <concatmanifest tempdir="${tmpdir}" manifest="${tmpdir}/MANIFEST.MF">
                <fileset dir="@{libdir}">
                    <include name="*.jar"/>
                    <exclude name="*javadocs*.jar"/>
                </fileset>
            </concatmanifest>
            <delete dir="${tmpdir}/META-INF" includeemptydirs="true" excludes="services/**"/>
            <metainf/>
        </sequential>
    </macrodef>
    
    <macrodef name="combine-jars-macro">
        <attribute name="classesdir"/>
        <attribute name="jarname"/>
        <element name="services" optional="true"/>
        <sequential>
            <property name="tmpdir" value="${dist.image.dir}/tmp"/>
            <jar destfile="../${dist.image.wsit.lib.dir}/@{jarname}.jar" manifest="${tmpdir}/MANIFEST.MF">
                <services/>
                <fileset dir="@{classesdir}"/>
            </jar>
        </sequential>
    </macrodef>
    
    <target name="-do-jar-without-manifest">
        <available file="${dist.image.dir}/tmp" type="dir" property="tooltime.jars.expanded"/>
        <antcall target="expand-jars-tooltime"/>
        <antcall target="combine-jars-tooltime"/>
    </target>

    <target name="expand-jars-tooltime" unless="tooltime.jars.expanded">
        <expand-jars-macro libdir="../${lib.tooltime.dir}"/>
    </target>

    <target name="combine-jars-tooltime">
        <combine-jars-macro jarname="${name}-tools" classesdir="build/classes">
            <services>
                <fileset dir="../etc">
                    <include name="META-INF/services/*.TWSDL*"/>
                    <include name="META-INF/services/*.TJava*"/>
                </fileset>
                <fileset dir="${tmpdir}">
                    <include name="**/*.*"/>
                    <exclude name="**/*.TWSDL*"/>
                    <exclude name="**/*.TJava*"/>
                </fileset>
            </services>
        </combine-jars-macro>
    </target>
    
</project>
